{"componentChunkName":"component---src-templates-blog-template-tsx","path":"/blog/16c4761606d6eeab2e5a/","result":{"data":{"markdownRemark":{"html":"<h4>\n<span id=\"概要\" class=\"fragment\"></span><a href=\"#%E6%A6%82%E8%A6%81\"><i class=\"fa fa-link\"></i></a>概要</h4>\n<hr>\n<p>herokuへのデプロイ中、アプリのslugsizeが前見た時の倍(100MB)になっていて<br>\nコーヒーこぼしかけた。</p>\n<p>最大サイズギリギリちゃうんかい！とおもったら最大は300Mらしく一安心したけど、<br>\nとりあえず調査。</p>\n<h4>\n<span id=\"めも\" class=\"fragment\"></span><a href=\"#%E3%82%81%E3%82%82\"><i class=\"fa fa-link\"></i></a>めも</h4>\n<hr>\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ heroku run bash --app アプリ名\n<p>heroku~ $ du -m -s *\n31  app\n9   bin\n1   config\n1   config.ru\n2   db\n2   doc\n1   Gemfile\n1   Gemfile.lock\n1   lib\n1   log\n1   Procfile\n59  public\n1   Rakefile\n1   README.md\n1   script\n1   spec\n1   ssl\n27  tmp\n180 vendor</p>\n<p>heroku~/vendor $ du -m -s *\n1   assets\n144 bundle\n1   heroku\n1   plugins\n36  ruby-1.9.3</p>\n<p>/vendor/bundle/ruby/1.9.1 $ du -m -s *\n1   bin\n1   build_info\n2   bundler\n1   bundler-1.3.2.gem\n1   doc\n142 gems\n1   specifications</p>\n</pre></div></div>\n<p>gemがほとんどなんだなーっと。でも最近gem入れてねーっすよ？？</p>\n<p>ってことは。。。</p>\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>~/public $ du -m -s *\n1   404.html\n1   422.html\n1   500.html\n58  assets\n1   favicon.ico\n1   mentenance.html\n1   robots.txt\n</pre></div></div>\n<p>。。。assetsの中も圧縮されたデータがハッシュ付きで入ってるしなー。<br>\nいままでassets:precompileをdeploy時にやっていたので、これを機にローカルでやるように切り替えよう。</p>\n<p>ローカルプリコンパイルを有効にして</p>\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>heroku labs:enable user-env-compile -a myapp\n</pre></div></div>\n<p>プリコンパイルして</p>\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>RAILS_ENV=production bundle exec rake assets:precompile\n</pre></div></div>\n<p>デプロイ！</p>\n<blockquote>\n<p>Asset precompilation completed (162.43s)</p>\n</blockquote>\n<p>これが</p>\n<blockquote>\n<p>Detected manifest.yml, assuming assets were compiled locally</p>\n</blockquote>\n<p>こうなる。yay!</p>\n<p>でも、slugsizeは変わりません。。。。</p>\n<p>調査の結果、次のようなやり方で解決しました。</p>\n<p><a href=\"https://github.com/rumblelabs/asset_sync\" rel=\"nofollow noopener\" target=\"_blank\">asset_sync</a>使ってprecompileしたassetsgがs3にあげてあるのに、<br><br>\nherokuのpublic/assetsにあげられていることが原因だった。</p>\n<p>というわけで、ローカルでプリコンパイルの設定を修正しました。</p>\n<h3>\n<span id=\"1-gitignoreの見直し\" class=\"fragment\"></span><a href=\"#1-gitignore%E3%81%AE%E8%A6%8B%E7%9B%B4%E3%81%97\"><i class=\"fa fa-link\"></i></a>1. gitignoreの見直し</h3>\n<p>下の二行を追加した。<br>\nmanifest.ymlにdigest付きの最新ファイルが記述してあり、<br><br>\nherokuではそれをベースにassetの参照先urlを生成しているので、そ<br>\nれ以外のassetsファイルをgit管理対象外とする。</p>\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>\npublic/assets/*\n!public/assets/manifest.yml\n</pre></div></div> \n<h3>\n<span id=\"2--プリコンパイル\" class=\"fragment\"></span><a href=\"#2--%E3%83%97%E3%83%AA%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB\"><i class=\"fa fa-link\"></i></a>2.  プリコンパイル</h3>\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>rake assets:precompile\n</pre></div></div>\n<p>一度ステージングのs3を削除しておいたので、全件アップ。<br>\nめっちゃ時間かかった。。。</p>\n<h3>\n<span id=\"3--herokuにpush\" class=\"fragment\"></span><a href=\"#3--heroku%E3%81%ABpush\"><i class=\"fa fa-link\"></i></a>3.  herokuにpush</h3>\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>git push heroku master\n-----&gt; Preparing app for Rails asset pipeline\n       Detected manifest.yml, assuming assets were compiled locally\n-----&gt; Discovering process types\n       Procfile declares types      -&gt; web, worker\n       Default types for Ruby/Rails -&gt; console, rake\n<p>-----> Compiled slug size: 59.8MB\n-----> Launching... done, v134</p>\n</pre></div></div>\n<p>100M --&gt; 59M</p>\n<p>めっちゃへった。ok。</p>\n<p>いろいろ試行錯誤してやったので、asset_pipelineのいい勉強になりました。<br><br>\nherokuはslugサイズ10Mを推奨しているらしい。今は69M弱。根本的に減らさないとまずいな。。。</p>","frontmatter":{"date":"2014-05-07","slug":"/blog/16c4761606d6eeab2e5a","title":"herokuでslugsizeが増えた！とりあえずローカルでassets:precompileする","image":null,"tags":["Rails","Heroku"]}}},"pageContext":{"slug":"/blog/16c4761606d6eeab2e5a"}},"staticQueryHashes":["1342192543"]}